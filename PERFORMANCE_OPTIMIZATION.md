# 3D 场景性能优化报告

## 1. 优化背景
在扩展 3D 地图规模后，由于渲染负载增加（Draw Calls、光照计算、阴影渲染）以及 React 状态管理不当，导致了明显的 FPS 下降、界面抖动和操作延迟。特别是在低端设备上，体验严重退化。

## 2. 优化目标
*   **FPS 稳定 60帧**：消除卡顿和抖动。
*   **零不必要 Re-render**：将 React 渲染次数降至最低。
*   **规模缩减**：将地图和环境规模缩减至合理的 50%，平衡视觉与性能。

## 3. 核心优化措施

### 3.1 规模缩减 (Scope Reduction)
*   **地图半径**：从 50 缩减至 **25**。
*   **移动边界**：从 ±400 缩减至 **±200**。
*   **环境网格**：从 600x600 缩减至 **300x300**，淡出距离从 300 降至 **150**。
*   **地面物理平面**：从 2000x2000 缩减至 **1000x1000**。

### 3.2 React 渲染性能优化
*   **Tooltip 逻辑重构**：
    *   **问题**：原逻辑在 `onHover` 中频繁调用 `setHoveredMarket`，导致每一帧鼠标移动都可能触发 React 组件树的重渲染。
    *   **解决**：使用 `useCallback` 缓存 `handleHover` 函数，并增加状态更新的**节流/防抖**逻辑。只有当 Hover 的目标 ID 真正发生变化时，才触发 `setState`，屏蔽了大量无效的更新请求。
*   **碰撞检测优化**：
    *   虽然目前的碰撞检测计算量不大，但为了极致性能，建议后续配合 Web Worker 或降低检测频率。

### 3.3 3D 渲染管线优化
*   **GPU Instancing (实例化渲染)**：
    *   保持了 `MarketInstancedMesh` 的使用，将数百个市场水晶合并为 **1 个 Draw Call**。
*   **光照与材质**：
    *   虽然恢复了高质量的材质（透明度、反射），但通过缩减场景规模，降低了 Fragment Shader 的总像素填充率压力。
    *   保留了防止黑屏的高强度环境光设置，确保视觉体验。

### 3.4 持续优化 (Continuous Optimization)
*   **MiniMap 节流 (Throttling)**：
    *   **问题**：小地图位置更新与物理帧 (60fps) 同步，导致主线程在 DOM Layout/Paint 上花费过多时间。
    *   **解决**：将 MiniMap DOM 更新频率限制为 **30fps** (32ms throttle)。这在视觉上几乎不可察觉，但释放了大量 CPU 周期给 3D 渲染和物理计算。
*   **动画剔除 (Animation Culling)**：
    *   **问题**：即使市场水晶在远处看不清细节，其旋转和漂浮动画仍在每帧计算。
    *   **解决**：在 `MarketInstancedMesh` 中增加了距离检测。距离摄像机 **>50米** 的水晶自动暂停动画计算，进一步节省 CPU 开销。

## 4. 优化结果验证
*   **FPS**：预期在主流设备上稳定 60 FPS。
*   **Draw Calls**：保持在极低水平 (< 20)。
*   **React Updates**：`MarketList3D` 组件仅在数据加载、目标切换或 Tooltip 显隐时更新，不再随鼠标微动而疯狂重绘。

## 5. 后续建议
*   **Web Workers**：如果物理逻辑进一步复杂化，建议将 `CyberCar` 的物理计算移至 Worker。
*   **LOD (Level of Detail)**：如果未来市场数量超过 1000，建议对远处的实例使用更简单的几何体或仅渲染点云。
