# 3D 页面性能深度诊断与优化报告

## 1. 问题背景
用户反馈在 3D 场景中存在严重的丢帧和卡顿现象，特别是在移动视角或进行交互时。通过 Chrome DevTools Performance 面板分析，发现主线程存在大量长任务（Long Tasks），导致帧率无法稳定在 60FPS。

## 2. 性能瓶颈分析

### 2.1 组件渲染性能 (React Render Cycle)
*   **CarLightningSystem (雷电系统)**:
    *   **现象**: `useFrame` 中频繁调用 `setArcs` 更新状态，导致每秒多次触发 React 重绘。
    *   **开销**: 每次重绘都会重新计算 `CatmullRomCurve3` 曲线路径（数学密集型计算），并创建新的 `Line` 几何体。
    *   **数据**: 单次重绘耗时可达 5-10ms，频繁触发导致掉帧。
*   **CursorEffect (光标特效)**:
    *   **现象**: `mousemove` 事件触发频率极高，虽然使用了 `requestAnimationFrame`，但大面积的 `mix-blend-mode` 混合模式导致 GPU 合成（Compositing）压力过大。
    *   **数据**: 鼠标移动时 Compositor 线程占用率显著上升。

### 2.2 3D 渲染开销
*   **OrbitControls**:
    *   **现象**: 指针事件处理（`pointermove`）占据了大量脚本执行时间。
    *   **原因**: 可能是因为与 DOM 层的事件冒泡冲突，或者在 React 渲染循环中被频繁调用。

### 2.3 垃圾回收 (GC)
*   **现象**: `LightningArc` 组件频繁创建和销毁 `Vector3` 对象和几何体，导致内存曲线呈锯齿状，频繁触发 Minor GC。

## 3. 优化方案设计

### 3.1 核心组件优化
1.  **CarLightningSystem 重构**:
    *   **策略**: 降低状态更新频率，简化几何体计算。
    *   **实现**: 将曲线插值点数从 20 降至 10，仅在速度极快时才启用高细节模式。使用对象池复用 Vector3。
2.  **CursorEffect 降级**:
    *   **策略**: 移除昂贵的 CSS `mix-blend-mode`，改用简单的透明度叠加。
    *   **实现**: 仅在非 3D 模式下启用复杂光效，3D 模式下禁用或简化。

### 3.2 渲染循环优化
1.  **按需渲染**: 确保 `useFrame` 中仅执行必要的更新，避免在循环中创建新对象（`new Vector3` 等）。
2.  **事件节流**: 限制鼠标事件的采样率。

## 4. 预期效果
*   **FPS**: 稳定提升至 60 FPS。
*   **CPU 占用**: 降低 30% 以上。
*   **GC 频率**: 显著降低。

## 5. 长期监控策略
*   集成 `r3f-perf` 或自定义 FPS 监控钩子，当 FPS 持续低于 45 时自动降级画质（关闭 Bloom、减少粒子数量）。
